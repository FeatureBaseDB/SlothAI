<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeatureBase AI - Query</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- Fixed Header -->
<nav class="navbar navbar-expand-lg fixed-top" style="opacity: 90%;">
    <img src="/static/fb.png" style="height: 1.5rem; width: auto; margin-right: 10px;"> 
    <h2 style="font-family: Roboto,sans-serif; color: #ffffff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); margin: 0;">FeatureBase AI</h2>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {{username}}
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                    <a class="dropdown-item" href="/logout">Logout</a>
                </div>
            </li>
        </ul>
    </div>
</nav>

<!-- Left Sidebar Navigation -->
<div class="sidebar">
    <!-- Include your sidebar links here -->
</div>

<!-- Left Sidebar Navigation -->
<div class="sidebar">
    <a href="/tables">
        <i class="fas fa-code-branch"></i> Pipelines
    </a>
    <a href="/query" class="highlighted-link">
        <i class="fas fa-search"></i> Query
    </a>
    <a href="/models">
        <i class="fas fa-cogs"></i> Models
    </a>

    <a href="/jobs">
        <i class="fas fa-tasks"></i> Jobs
    </a>
    <a href="/settings">
        <i class="fas fa-cog"></i> Settings
    </a>
</div>

<div class="content container mt-5 pt-5">
    {% for message in get_flashed_messages() %}
        <div id="tempNotice" class="alert alert-info d-none" role="alert">{{ message }}</div>
    {% endfor %}
    
    <h2 class="page_heading">Query</h2>

    <div class="card rounded-lg">
        <div class="card-body">
            <p class="card-text">
                <ul class="nav nav-pills">
                  <li class="nav-item">
                    <a class="nav-link active" href="#">Enterprise Search</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Document Chat</a>
                  </li>
                </ul>
            </p>
            <p class="card-text">You can use FeatureBaseAI's API to search data intelligently, once it is saved in your FeatureBase. Use the pulldown to select the table to query and then write any type of query to test a search. If you have attributes saved as set fields, their pulldowns may be used to limit the search.</p>

            {% for message in get_flashed_messages() %}
            <div id="tempNotice" class="alert alert-info d-none" role="alert">{{ message }}</div>
            {% endfor %}
            
            <!-- Inside the <select> element, use a for loop to populate the options -->
            {% if tables|length > 0 %}
            <select class="form-select" id="tableSelect">
                <option selected>Select Table</option>
                {% for table in tables %}
                    <option value="{{ table.tid }}">{{ table.name }}</option>
                {% endfor %}
            </select>
            {% else %}
            You need to populate a table first by using one of your <a href="/tables">pipelines</a>.
            {% endif %}

            <div id="pullDowns"></div>

            <!-- Add a <form> element to wrap the input fields and button -->
            <form id="queryForm">
                <div class="d-flex justify-content-between mt-4">
                    <div class="input-group">
                        <input type="text" id="query" class="form-control" placeholder="enter a query...">
                    </div>
                    <button type="submit" class="btn btn-primary ms-2">Query</button>
                </div>
            </form>

            <div id="resultDiv" class="mt-4">
                <!-- Result content will be displayed here -->
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>


<script type="text/javascript">
$(document).ready(function() {

    function createPulldowns(data) {
        // Identify the container where you want to append the pulldowns.
        const container = $('#pullDowns');

        // Clear the container first to ensure old pulldowns are removed.
        container.empty();

        $.each(data, function(key, values) {
            let divContainer = $('<div>');
            let labelElem = $('<label>').text(key);
            let selectElem = $('<select>').attr('id', key );
            let optgroupElem = $('<optgroup>').attr('label', key);

            optgroupElem.append($('<option>').text('None').val('none'));

            $.each(values, function(index, value) {
                optgroupElem.append($('<option>').text(value).val(value));
            });

            selectElem.append(optgroupElem);
            divContainer.append(labelElem);
            divContainer.append(selectElem);

            container.append(divContainer);
        });
    }

    $("#tableSelect").on("change", function() {
        var selectedTable = $(this).val();
        $.ajax({
            type: "GET",
            url: `/tables/${selectedTable}/schema`,
            contentType: "application/json",
            success: function(response) {
                column_list = []
                $.each(response, function(key, values) {
                    if (values == "stringset") {
                        column_list.push(key);
                    }
                });
                console.log(column_list)
                $.ajax({
                    type: "POST",
                    url: `/tables/${selectedTable}/unique_values`,
                    data: JSON.stringify({"columns": column_list}),
                    contentType: "application/json",
                    success: function(data) {
                        createPulldowns(data);
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });  
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    });

    $("form").submit(function(event) {
        event.preventDefault(); // Prevent the default form submission
        
        // Get the selected table and user-entered query
        const selectedTable = $("select").val();
        const query = $("#query").val();
        
        // Check if a table is selected and a query is provided
        if (selectedTable === "Select Table" || query.trim() === "") {
            alert("Please select a table and enter a query.");
            return;
        }
        
        // Prepare the JSON data
        const jsonData = {
            "query": query,

        };
        
        // call the query endpoint
        $.ajax({
            type: "POST",
            url: `/tables/${selectedTable}/query`,
            contentType: "application/json",
            data: JSON.stringify(jsonData),
            success: function(response) {
                // Handle the success response by updating the resultDiv
                const resultHtml = `
                    <strong>SQL Query:</strong>
                    <pre>${response.sql}</pre>
                    <strong>Explaination:</strong>
                    <pre>${response.explain}</pre>
                `;
                $("#resultDiv").html(resultHtml);
            },
            error: function(xhr, status, error) {
                // Handle errors here
                console.error(xhr.responseText);
            }
        });
    });
});

</script>

</script>
</body>
</html>

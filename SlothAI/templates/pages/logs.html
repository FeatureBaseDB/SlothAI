{% extends "pages/page_base.html" %}

{% block title %}
<title> Logs | SlothAI</title>
<meta property='og:title' content='Tasks | SlothAI'/>
{% endblock %}

{% block content %}
<div class="content container mt-5 pt-5">
    <h2 class="page_heading">Callback Logs</h2>
    <p>When you use the default callback, logs of the document at that point in the pipeline will be shown here. Logs expire after 1 hour.</p>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Log</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
                <tr>
                    <td>{{ log.created }}</td>
                    <td data-log="{{ log.line }}"></td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <button class="reload-button btn btn-success">
        <i class="fas fa-sync-alt"></i> Reload
    </button>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
$(document).ready(function() {
    $('.reload-button').on('click', function() {
      window.location.reload();
    });

    $("table tbody tr").each(function() {
        var tdLog = $(this).find("td[data-log");
        var rawData = tdLog.data('log');
        var cleanedData = rawData.slice(2, -1);
        var jsonDataObj;
        console.log(cleanedData)

        try {
            jsonDataObj = JSON.parse(cleanedData);
            for (var key in jsonDataObj) {
                if (key.toLowerCase().includes('token')) {
                    delete jsonDataObj[key];
                }
            }
        } catch (error) {
            console.log("error")
            jsonDataObj = { "ParsingError": "Error parsing JSON" };
        }

        var preContent = JSON.stringify(jsonDataObj, null, 2);
        tdLog.html('<pre style="font-size: 10px;">' + preContent + '</pre>');

        if (!jsonDataObj || jsonDataObj.ParsingError) {
            tdLog.find('pre').text(cleanedData);
        }

        let inactivityTimer;
        function reloadPage() { window.location.reload(); }
        function startInactivityTimer() { inactivityTimer = setTimeout(reloadPage, 60000); }
        function resetInactivityTimer() { clearTimeout(inactivityTimer); startInactivityTimer(); }

        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keydown', resetInactivityTimer);

        startInactivityTimer();
    });



    // Iterate through table rows
    $("table tbody tr").each(function() {
        var tdLog = $(this).find("td[data-log"); // Find the <td> with data-log attribute

        // Extract the log data from the data attribute
        var rawData = tdLog.data('log');

        // Remove the 'b' prefix and single quotes
        var cleanedData = rawData.slice(2, -1);

        // Parse the JSON data for the current row
        var jsonDataObj = JSON.parse(cleanedData);

        // Remove key-value pairs with keys containing 'token'
        for (var key in jsonDataObj) {
          if (key.toLowerCase().includes('token')) {
            delete jsonDataObj[key];
          }
        }

        // is it a travesty that I didn't write any of this?
        let inactivityTimer; // Initialize a timer variable

        // Function to reload the page
        function reloadPage() {
          window.location.reload();
        }

        // Function to start the inactivity timer
        function startInactivityTimer() {
          inactivityTimer = setTimeout(reloadPage, 30000); // Reload the page after 1 minute (60000 milliseconds)
        }

        // Function to reset the inactivity timer
        function resetInactivityTimer() {
          clearTimeout(inactivityTimer); // Clear the previous timer
          startInactivityTimer(); // Start a new timer
        }

        // Event listeners for mouse and keyboard activity
        document.addEventListener('mousemove', resetInactivityTimer); // Mouse activity
        document.addEventListener('keydown', resetInactivityTimer); // Keyboard activity

        // Start the initial timer
        startInactivityTimer();
        // Probably not.

        // Display the formatted JSON without 'token' entries in the "Log" column
        tdLog.html('<pre style="font-size: 10px;">' + JSON.stringify(jsonDataObj, null, 2) + '</pre>');
    });
});
</script>
{% endblock %}



{% extends "pages/page_base.html" %}

{% block title %}
<title>Pipelines | FeatureBase AI</title>
<meta property='og:title' content='Pipelines | FeatureBase AI'/>
{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="content container mt-5 pt-5">
    <h2 class="page_heading">Pipelines</h2>

    {% if pipelines %}
    <div class="rounded-lg border p-3">
        <h4 class="mb-3">Your Pipelines</h4>
        <p>Pipelines route data from endpoints to nodes. Nodes may transform the data, or write to and read from the database. Once data has been processsed by the pipeline's nodes, it can be queried in your <a href="https://cloud.featurebase.com/query/">FeatureBase Cloud</a> account with SQL.</p>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Nodes</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for pipeline in pipelines %}
                <tr>
                    <td><a href="/pipelines/{{ pipeline.pipe_id }}">{{ pipeline.name }}</a></td>
                    <td>
                        {% for node in pipeline.node_ids %}
                        <span class="badge badge-warning">{{ node }}</span>
                        {% endfor %}
                    </td>
                    <td>
                        <button class="delete-button btn btn-danger" data-pipeline-id="{{ pipeline.pipe_id }}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <p></p>
    <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#nodeFormModal">
        Add Pipeline
    </button>

    {% else %}

    <div class="rounded-lg border p-3">
        <h4 class="mb-3">Create a Pipeline</h4>
        <p>Click on the "Add Pipeline" button to create a new Pipeline. Pipelines are lists of Nodes run in order on data.</p>

        <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#nodeFormModal">
            Add Pipeline
        </button>
        <p></p>
        <p>An endpoint for ingesting data will be shown once the pipeline is created.</p>
        <p>Using the endpoint will look like this:</p>
        <div class="code-block">curl -X POST \
    -H "Content-Type: application/json" \
    -d '{"text":"There was a sudden knock at the door, then silence."}' \
    https://ai.featurebase.com/ingest/&lt;endpoint_id&gt;?token=&lt;token&gt;</div>
        <p></p>
        <p>When the document task sent, a response will look like this:</p>
        <div class="code-block">{
    "data": {
        "attributes": [
            [
                "frontdoor",
                "sound",
                "person"
            ]
        ],
        "text": [
            "There was a knock at the door, then silence."
        ]
    },
    "job_id": "9575216437535982918",
    "nodes": [
        {
            "name": "instructor-large"
        },
        {
            "name": "gpt-3.5-turbo"
        }
    ],
    "name": "demos",
    "tid": "QP46NBAHv2GntTOIf"
}</div>
    </div>
    {% endif %}

<div class="modal fade" id="nodeFormModal" tabindex="-1" role="dialog" aria-labelledby="nodeFormModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title card-callout" id="nodeFormModalLabel">Create Pipeline</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- New node selection section -->
                <div class="form-group">
                    <label for="pipelineName">Pipeline Name</label>
                    <input type="text" class="form-control" id="pipelineName" placeholder="Pipeline name">
                </div>

<div class="form-group">
    <label for="selectedNode">Add Node</label>
    <div class="input-group">
        <select class="form-control" id="selectedNode">
            <optgroup id="nodePulldown" label="Available Nodes">
                <option data-node_name="none">None</option>
                {% for node in nodes %}
                    <option data-node_name="{{ node.name }}" data-node_extras="{{ node.extras }}" data-node_processor="{{ node.processor }}">{{ node.name }} ({{ node.processor }})</option>
                {% endfor %}
            </optgroup>
        </select>
        <div class="input-group-append">
            <button id="addNodeToList" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button>
        </div>
    </div>
</div>


<!-- Node list section -->
<div style="margin-top: 20px" class="form-group">
    <p id="ListMessage">Pipeline will write directly to FeatureBase.</p>
    <div class="rounded-lg border p-3" id="selectedNodesContainer" style="display: none;">
        <!-- Content inside the container -->
    </div>
</div>

            </div>
<div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Cancel</button>
    <button type="button" class="btn btn-dark" id="createButton">Create</button>
</div>

        </div>
    </div>
</div>


</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
$(document).ready(function () {
    // Attach a click event handler to the delete buttons
    $(".delete-button").on("click", function () {
        var pipelineId = $(this).data("pipeline-id");
        var $this = $(this);
        var rowCount = $(".pipeline tbody tr").length;
        $this.addClass("flash");
        // Send an AJAX request to delete the pipeline with the DELETE method
        $.ajax({
            url: '/pipeline/' + pipelineId,
            type: 'DELETE',
            success: function (response) {
                $this.closest("tr").remove();
                if (rowCount === 1) {
                    window.location.reload();
                }
            },
            error: function (error) {
                console.error("Error deleting pipeline:", error);
            }
        });
    });

    function toggleSelectedNodesContainer() {
        if (selectedNodes.length > 0) {
            $('#selectedNodesContainer').show();
        } else {
            $('#selectedNodesContainer').hide();
        }
    }

    const selectedNodeDropdown = $('#selectedNode');
    const addNodeButton = $('#addNodeToList');
    const selectedNodesContainer = $('#selectedNodesContainer');
    const ListMessage = $('#ListMessage');

    const selectedNodes = []; // Initialize an array to store selected nodes

    addNodeButton.click(function () {
        const selectedNodeOption = selectedNodeDropdown.find(':selected');
        const selectedNode = selectedNodeOption.val();
        const selectedNodeExtras = selectedNodeOption.data('node_extras');
        const selectedNodeProcessor = selectedNodeOption.data('node_processor');

        if (selectedNode !== "None" && selectedNode && !selectedNodes.includes(selectedNode)) {
            selectedNodes.push(selectedNode);

            // Determine the badge type based on the selectedNodeMethod
            const processorToButtonType = {
                "bare": "btn-secondary",
                "callback": "btn-primary",
                "uri_to_text": "btn-success",
                "uri_to_stringset": "btn-info",
                "text_to_strings": "btn-danger",
                "strings_to_stringset": "btn-warning",
                "stringset_to_strings": "btn-light",
                "strings_to_embeddings": "btn-dark",
                "embedding_to_sql": "btn-info",
                "dict_to_sql": "btn-primary",
                "dict_to_table": "btn-success",
            };

            let buttonType = processorToButtonType[selectedNodeProcessor] || "btn-outline-success";


            const trashIcon = $('<i></i>', {
                class: 'fas fa-trash-alt', // Font Awesome trashcan icon
            });

            const buttonGroup = $('<div></div>', {
                class: 'btn-group btn-group-toggle',
                'data-toggle': 'buttons',
            });

            const deleteButton = $('<a></a>', {
                tabindex: 0, // Add tabindex for focus
                role: 'button',
                class: `btn btn-danger rounded-right`, // Rounded on the right, red (danger)
                title: 'Delete Node',
                click: function () {
                    const indexToRemove = selectedNodes.indexOf(selectedNode);
                    if (indexToRemove !== -1) {
                        selectedNodes.splice(indexToRemove, 1);
                    }
                    listItem.remove();
                    if (selectedNodes.length === 0) {
                        ListMessage.text('Pipeline will write directly to FeatureBase.');
                    }

                    selectedNodeDropdown.val("None");
                    toggleSelectedNodesContainer();

                },
            });

            deleteButton.append(trashIcon); // Add trashcan icon to the delete button

            const badge = $('<a></a>', {
                tabindex: 0, // Add tabindex for focus
                role: 'button',
                class: `btn ${buttonType}`,
                text: selectedNode,
                'data-toggle': 'popover', // Add data-toggle for the popover
                title: 'Node Info', // Title for the popover
                'data-trigger': 'focus', // Close popover on focus
                'data-content': `Extras: ${selectedNodeExtras} Processor: ${selectedNodeProcessor}`, // Content for the popover
            });

            buttonGroup.append(badge);
            buttonGroup.append(deleteButton); // Place the trashcan button on the right

            const listItem = $('<div></div>', {
                class: 'selected-node',
            });

            listItem.append(buttonGroup);

            selectedNodesContainer.append(listItem);
            ListMessage.text('Pipeline execution order:');
            toggleSelectedNodesContainer();

            // Initialize Bootstrap popovers for the badge elements
            badge.popover({
                trigger: 'focus',
            });
        }
    });

    var formFields = [
        { name: 'pipelineName', id: 'pipelineName' },
        { name: 'nodes', id: 'nodes' }
    ];

$("#createButton").click(function () {
    var formData = {};

    // Populate formData object from formFields array
    for (var i = 0; i < formFields.length; i++) {
        var field = formFields[i];
        formData[field.name] = $("#" + field.id).val();
    }

    formData.nodes = selectedNodes;

    // Move this to a notice in the form
    if (!/^[a-z-_]+$/.test(formData.pipelineName)) {
        toastr.error("Invalid pipeline name. Pipeline name should only contain lowercase letters, '-', and '_'.");
    } else {
        $.ajax({
            type: "POST",
            url: "/pipeline",
            data: JSON.stringify(formData), // Send data as JSON
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                window.location.href = "/pipelines/" + response.tid;
            },
            error: function (error) {
                console.error("Error submitting form:", error);
            }
        });
    }
});


});
</script>
{% endblock %}